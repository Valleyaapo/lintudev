---
import Layout from '../../layouts/Layout.astro';
import ProjectTemplate from '../../components/ProjectTemplate.astro';
import { projects, getNextProject } from '../../data/projects';
import { getImage } from "astro:assets";

export function getStaticPaths() {
  return projects.map((project) => ({
    params: { id: project.id },
    props: { project, nextProject: getNextProject(project.id) }
  }));
}

const { project, nextProject } = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/*.{jpeg,jpg,png,gif}', { eager: true });
const heroFilename = project.heroImage.split('/').pop();
const heroImageMetadata = images[`/src/assets/${heroFilename}`]?.default;

const site = Astro.site || 'https://lintu.dev';
let heroImageUrl = project.heroImage;

if (heroImageMetadata) {
  const optimizedHero = await getImage({ src: heroImageMetadata, format: 'jpg' });
  heroImageUrl = new URL(optimizedHero.src, site).toString();
}

const keywords = [
  project.category,
  ...project.stack.split(', '),
  project.service,
  'case study',
  'portfolio',
  'development',
  project.client !== 'Self-Published' && project.client !== 'Personal Project' ? project.client : null
].filter(Boolean).join(', ');
---

<Layout 
  title={project.title}
  description={project.description}
  image={heroImageUrl}
  type="article"
>
  <Fragment slot="head">
    <meta name="keywords" content={keywords} />
    <meta property="article:published_time" content={`${project.year}-01-01`} />
    <meta property="article:author" content="Lintu Dev Studio" />
    <meta property="article:tag" content={project.category} />
    <meta property="article:tag" content={project.stack.split(', ').join(',')} />
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": project.title,
      "description": project.description,
      "image": heroImageUrl,
      "datePublished": `${project.year}-01-01`,
      "author": {
        "@type": "Organization",
        "name": "Lintu Dev Studio"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Lintu Dev Studio",
        "logo": {
          "@type": "ImageObject",
          "url": new URL('/icon.svg', site).toString()
        }
      },
      "keywords": keywords
    })} />
  </Fragment>
  
  <ProjectTemplate
    project={project}
    nextProject={nextProject}
    heroImageMetadata={heroImageMetadata}
  />
</Layout>
